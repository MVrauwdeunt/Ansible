---

# - name: add nginx apt repository
#   apt_repository:
#     repo: 'deb http://nginx.org/packages/mainline/ubuntu/ xenial nginx'
#     state: present
#     filename: just
#     update_cache: yes
# - name: wget prebuilt-mpr
#   command: "wget -qO - 'https://proget.makedeb.org/debian-feeds/prebuilt-mpr.pub' | gpg --dearmor | sudo tee /usr/share/keyrings/prebuilt-mpr-archive-keyring.gpg 1> /dev/null"
# - name: echo prebuilt keyring
#   command: 'echo "deb [arch=amd64 signed-by=/usr/share/keyrings/prebuilt-mpr-archive-keyring.gpg] https://proget.makedeb.org prebuilt-mpr $(lsb_release -cs)" | sudo tee /etc/apt/sources.list.d/prebuilt-mpr.list'
# - name: update apt
#   command: "apt update"
#   become: yes

- name: Manage directories
  become: true
  ansible.builtin.file:
    path: "/usr/share/keyrings"
    state: directory
    mode: "0755"

# Fetch gpg keys for trusted apt repositories
- name: Download apt repository gpg keys
  become: true
  ansible.builtin.get_url:
    url: "https://proget.makedeb.org/debian-feeds/prebuilt-mpr.pub"
    dest: "/usr/share/keyrings/prebuilt-mpr-archive-keyring.gpg"
    mode: "0644"

- name: Extract and replace gpg keys with dearmor
  become: true
  ansible.builtin.command:
    cmd: "gpg --dearmor /usr/share/keyrings/prebuilt-mpr-archive-keyring"
    creates: "/usr/share/keyrings/prebuilt-mpr-archive-keyring.gpg"

- name: Add apt repositories
  become: true
  ansible.builtin.apt_repository:
    repo: "deb [arch=amd64 signed-by=/usr/share/keyrings/prebuilt-mpr-archive-keyring.gpg] https://proget.makedeb.org prebuilt-mpr {{ ansible_distribution_release }}"

- name: Update system
  become: true
  ansible.builtin.apt:
    upgrade: 'yes'
    update_cache: true

- name: install just
  package:
    name: "just"

- name: generate justfile file from template
  tags: justfile
  template:
    src: "templates/justfile.j2"
    dest: "/home/{{ user }}/.justfile"
    owner: "{{ user }}"
    group: "{{ user }}"
    mode: 0644